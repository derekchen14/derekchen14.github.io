<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>How to Fix Memory Error when training on AWS GPU with Keras</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="../assets/built/screen.css%3Fv=245ecc38c2.css" />

    <meta name="description" content="Error allocating 86118 KBs of device memory (out of memory).  Driver report 32735 KBs free and 4294771 KBs total. Fixing this can be quite involved ..." />
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="More Than One Turn" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="How to Fix Memory Error when training on AWS GPU with Keras" />
    <meta property="og:description" content="Error allocating 86118 KBs of device memory (out of memory).  Driver report 32735 KBs free and 4294771 KBs total. Fixing this can be quite involved ..." />
    <meta property="og:url" content="http://localhost:2368/memory-error-when-training-keras-in-aws-gpus/" />
    <meta property="article:published_time" content="2016-03-07T00:00:00.000Z" />
    <meta property="article:modified_time" content="2016-03-29T16:25:00.000Z" />
    <meta property="article:tag" content="gpu" />
    <meta property="article:tag" content="memory error" />
    <meta property="article:tag" content="deep learning" />
    <meta property="article:tag" content="theano" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="How to Fix Memory Error when training on AWS GPU with Keras" />
    <meta name="twitter:description" content="Error allocating 86118 KBs of device memory (out of memory).  Driver report 32735 KBs free and 4294771 KBs total. Fixing this can be quite involved ..." />
    <meta name="twitter:url" content="http://localhost:2368/memory-error-when-training-keras-in-aws-gpus/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Derek Chen" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="gpu, memory error, deep learning, theano" />
    <meta name="twitter:site" content="@derekchen14" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "More Than One Turn",
        "url": "http://localhost:2368/",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "Derek Chen",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/9f3ee838eeb42849d4880676cedd85d6?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://localhost:2368/author/derek/",
        "sameAs": []
    },
    "headline": "How to Fix Memory Error when training on AWS GPU with Keras",
    "url": "http://localhost:2368/memory-error-when-training-keras-in-aws-gpus/",
    "datePublished": "2016-03-07T00:00:00.000Z",
    "dateModified": "2016-03-29T16:25:00.000Z",
    "keywords": "gpu, memory error, deep learning, theano",
    "description": "For my Stanford Convolutional Neural Networks course\n[http://cs231n.stanford.edu], I partnered with a brilliant friend of mine to\nanalyze images from a collection of 40,000 digitized works of art by classifying\nthem according to artist, genre, and location. After some standard\npre-processing, we employed a modified VGGNet architecture to achieve better\nthan state-of-the-art results [http://arxiv.org/pdf/1505.00855v1.pdf] on artist\nand genre classification. Along the way though, we hit a number o",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.29" />
    <link rel="alternate" type="application/rss+xml" title="More Than One Turn" href="../rss/index.html" />
    <style>
.page-title,
.page-description {
   color:#3D0F90!important;
   text-shadow: #F7FAEB 0px 0px 0.3em;
}
a { color: #3399ff; }  
.nav li a:after { display: none; }
.nav li:before { display: none; }
li { margin: 0.2em 0; }
ol, ul {
	margin: 0;
    position: relative;
}
ol > li, ul > li { bottom: 0; }
p { margin: 0 0 0.7em 0; }
.main-header { height: 90vh; }

article.post { width: 100%; }
section.post-full-content {
    padding: 0;
    line-height: 1em;
    font-size: 1.4em;
}
h1.site-title, h2.site-description { 
    text-shadow: 2px 2px 3px #232522;
} 
    
</style>

</head>
<body class="post-template tag-gpu tag-memory-error tag-deep-learning tag-theano">

    <div class="site-wrapper">

        

<header class="site-header">
    <div class="outer site-nav-main">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left-wrapper">
        <div class="site-nav-left">
                <a class="site-nav-logo" href="../index.html">More Than One Turn</a>
            <div class="site-nav-content">
                    <ul class="nav">
    <li class="nav-home"><a href="../index.html">Home</a></li>
    <li class="nav-about"><a href="http://feature.engineering/about">About</a></li>
    <li class="nav-contact"><a href="http://feature.engineering/contact">Contact</a></li>
</ul>

                    <span class="nav-post-title dash">Memory Error when Training in AWS GPUs</span>
            </div>
        </div>
    </div>
    <div class="site-nav-right">
            <div class="social-links">
                    <a class="social-link social-link-tw" href="https://twitter.com/derekchen14" title="Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            </div>
                <a class="rss-button" href="https://feedly.com/i/subscription/feed/http://localhost:2368/rss/" title="RSS" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg>
</a>

    </div>
</nav>
    </div>
</div></header>


<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post tag-gpu tag-memory-error tag-deep-learning tag-theano no-image no-image">

            <header class="post-full-header">

                <section class="post-full-tags">
                    <a href="../tag/gpu/index.html">gpu</a>
                </section>

                <h1 class="post-full-title">Memory Error when Training in AWS GPUs</h1>


                <div class="post-full-byline">

                    <section class="post-full-byline-content">

                        <ul class="author-list">
                            <li class="author-list-item">

                                <div class="author-card">
                                    <img class="author-profile-image" src="http://www.gravatar.com/avatar/9f3ee838eeb42849d4880676cedd85d6?s=250&amp;d=mm&amp;r=x" alt="Derek Chen" />
                                    <div class="author-info">
                                        <h2>Derek Chen</h2>
                                        <p>Read <a href="../author/derek/index.html">more posts</a> by this author.</p>
                                    </div>
                                </div>

                                <a href="../author/derek/index.html" class="author-avatar">
                                    <img class="author-profile-image" src="http://www.gravatar.com/avatar/9f3ee838eeb42849d4880676cedd85d6?s=250&amp;d=mm&amp;r=x" alt="Derek Chen" />
                                </a>

                            </li>
                        </ul>

                        <section class="post-full-byline-meta">
                            <h4 class="author-name"><a href="../author/derek/index.html">Derek Chen</a></h4>
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2016-03-07">7 Mar 2016</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 4 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>


            <section class="post-full-content">
                <div class="post-content">
                    <!--kg-card-begin: markdown--><p>For my Stanford <a href="http://cs231n.stanford.edu">Convolutional Neural Networks course</a>, I partnered with a brilliant friend of mine to analyze images from a collection of 40,000 digitized works of art by classifying them according to artist, genre, and location.  After some standard pre-processing, we employed a modified VGGNet architecture to achieve better than <a href="http://arxiv.org/pdf/1505.00855v1.pdf">state-of-the-art results</a> on artist and genre classification. Along the way though, we hit a number of roadblocks, and saw <code>Error allocating 86118400 bytes of device memory (out of memory). Driver report 32735232 bytes free and 4294770688 bytes total.  Segmentation fault (core dumped)</code> more times than we would like to remember.  In getting our network to  run to properly, we encountered a number of problems and their solutions.</p>
<p><strong>Quick Fixes</strong><br>
If you haven't done any kind of optimization yet:</p>
<ul>
<li>Consider running your network on a <a href="http://localhost:2368/memory-error-when-training-keras-in-aws-gpus/feature.engineering/training-on-big-data/">AWS 2.2xlarge GPU</a> or a similar offering from another cloud provider.  Not only will this provide a boost in power, your cloud instance will likely have greater memory to work with as well.</li>
<li>Reduce the size of your network by removing extra layers or limit the number of nodes per layer.  Think about other straightforward variables you can reduce, such as the number of examples to train on.  This will likely lower the final accuracy of the neural net, but if you're just trying to get something to run, limiting the network is a good place to start.</li>
<li>Close all other programs that are running on your computer that might be eating up memory.  <a href="http://lifehacker.com/why-chrome-uses-so-much-freaking-ram-1702537477">Chrome</a> and its independent tab processes are often a hungry source for gobbling up CPU and RAM.  Use <a href="https://support.apple.com/en-us/HT201464">Activity Monitor</a> from your Mac OSX toolbox to find out what other culprits might be at play.</li>
<li>Simplify the architecture of your overall system by commenting it out.  For example, if your final prediction uses ensembling from multiple models, temporarily use just a single model at a time.  The same idea applies for data augmentation, complex feature engineering, and using specialized hyperparameters.</li>
</ul>
<p><strong>Diving Deeper</strong><br>
This next level of ideas requires the user to dig into their code a bit to understand what is happening.  Simple editing of a copy/pasted example file will no longer suffice:</p>
<ul>
<li>Compiled models potentially hold onto millions of weights and variables in addition their actual structure, and should not be stored unnecessarily.  As an example, assume you are training multiple networks at once during a grid search for hyperparameters.     During each training loop, you store the best model so that you can  use it during the testing phase.  A better use of memory though might be to store just the best params used in creating the model, rather than the full model itself.</li>
<li>Reduce your the batch size of each epoch.  While this may seem like a quick fix, it requires understanding the trade-offs between having different sized batches.  Additionally, unless the neural network was written in a clean style, changing this variable might involve touching multiple places in your code.</li>
<li>Load your input vectors as 'float32' rather than 'float64', which is the default of <code>numpy.load</code> using the <code>astype()</code> method.  In most cases, your network will not benefit from having the extra precision of the extra 32 bits, so changing the input type can be a great way to cut down your feature memory usage in half.</li>
<li>If your dataset is too large, you can try splitting your dataset into smaller chunks so that each individual piece can fit into memory.  This process can be performed by simply chunking up your data through numpy if you are planning to save the features as .npy files.  Alternatively, h5py has methods that allow the user to pull only certain slices of the data into memory at once.  Keras offers a nice wrapper around this functionality in their <a href="https://github.com/fchollet/keras/blob/master/keras/utils/io_utils.py#L7">I/O tools</a>.</li>
</ul>
<p><strong>Finding Root Causes</strong><br>
Finally, Linux command line tools can help pinpoint the exact moment where your network falls apart:</p>
<ul>
<li>To find out how much CPU memory is available, you can use <code>top</code> or <code>watch free</code> to tail the logs. In order to get more human-readable output for top, press Shift+E.  Similarly, in order to get more human-readable output for free, use the <code>-k</code> or <code>-m</code> flag to get kilobytes and megabytes, respectively.  It can be quite beneficial to <a href="http://www.linuxnix.com/find-ram-size-in-linuxunix/">study the guides</a> briefly to gain a better understanding of the output as opposed to blindly jumping in.</li>
<li>Get GPU memory information by using <code>nvidia-smi</code> or <code>intel_gpu_top</code> for Nvidia and Intel chips, respectively.  Many times you should know the maximum capacity of your graphics card, so be sure that the numbers you see line up with your understanding.  For the typical AWS GPU, this will be 4GB of video memory.  Once again, investing some time perusing the <a href="https://developer.nvidia.com/nvidia-system-management-interface">documentation</a> or just some brief searching can prove to be invaluable.</li>
<li>Use <code>timer.sleep(x)</code> in order to pause processing so you can see what memory allocation is directly before and after you perform an action, such as creating a new variable.  Combined with the tools above, you should now be able to see exactly when memory usage starts to explode, and hopefully what source caused it to happen.</li>
<li>Once the issue has been identified, consider if any of the techniques mentioned earlier might ameliorate the situation.  Another idea is setting any data or weights to None after you are done using them.  For example, in the case where new chunks of data are loaded sequentially to train the network, setting <code>X_train = None</code> and <code>y_train = None</code> at the end of each loop could make a difference.</li>
<li>Finally, although Python should take care of garbage collection pretty well, using <code>sys.stdout.flush()</code> to clear out any unused variables could make the difference.</li>
</ul>
<p>Like any good programmer, I simply kept forging ahead until I was able to figure out something that worked.  Thus, for my purposes,  these methods were enough to get my network to run to completion, and I hope they will help you as well.  Although, if problems still remain despite having pushed this far, and you are adamant of running your network at full capacity, then it might be time to invest in a <a href="http://timdettmers.com/2014/08/14/which-gpu-for-deep-learning/">more powerful chip</a> and develop your own custom set-up.</p>
<p>With practically unlimited access to resources, the folks at Google, Facebook, and Baidu certainly aren't facing the same type of issues, and instead are employing techniques well beyond the scope of this article.  However, using just hardware generally available to the public, even amateur researchers might be able to push these ideas further than I have.  If you are one of these people, please leave your tips and tricks in the comments below.</p>
<!--kg-card-end: markdown-->
                </div>
            </section>



        </article>

    </div>
</main>

<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
                <article class="read-next-card">
                    <header class="read-next-card-header">
                        <h3><span>More in</span> <a href="../tag/gpu/index.html">gpu</a></h3>
                    </header>
                    <div class="read-next-card-content">
                        <ul>
                            <li>
                                <h4><a href="../training-on-big-data/index.html">Deep Learning using GPUs in the Cloud</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2016-01-11">11 Jan 2016</time> –
                                        6 min read</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <footer class="read-next-card-footer">
                        <a href="../tag/gpu/index.html">1 post
                            →</a>
                    </footer>
                </article>

                <article class="post-card post no-image no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="../viv-and-the-future-of-digital-assistants-2/index.html">

            <header class="post-card-header">
                <h2 class="post-card-title">VIV and the Future of Digital Assistants</h2>
            </header>

            <section class="post-card-excerpt">
                    <p>Recently VIV debuted its flagship product at TechCrunch Disrupt to great fanfare, but unfortunately the results didn't quite match up to the hype.  Let's first talk about what they did right.  The founders at VIV have spent a lot of time thinking about what</p>
            </section>

        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
            
                    <div class="author-name-tooltip">
                        Derek Chen
                    </div>
            
                    <a href="../author/derek/index.html" class="static-avatar">
                        <img class="author-profile-image" src="http://www.gravatar.com/avatar/9f3ee838eeb42849d4880676cedd85d6?s=250&amp;d=mm&amp;r=x" alt="Derek Chen" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/derek/index.html">Derek Chen</a></span>
                <span class="post-card-byline-date"><time datetime="2016-05-15">15 May 2016</time> <span class="bull">&bull;</span> 4 min read</span>
            </div>
        </footer>

    </div>

</article>

                <article class="post-card post tag-rnn no-image no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="../difference-between-lstm-and-gru-for-rnns/index.html">

            <header class="post-card-header">
                    <div class="post-card-primary-tag">RNN</div>
                <h2 class="post-card-title">Difference between LSTM and GRU for RNNs</h2>
            </header>

            <section class="post-card-excerpt">
                    <p>So if you've started studying RNNs, and you heard that LSTMs and GRUs at the type of RNNs you should use because vanilla RNNs suffer from the vanishing gradient problem.  That makes sense because the hidden state is passed along for each iteration, so</p>
            </section>

        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
            
                    <div class="author-name-tooltip">
                        Derek Chen
                    </div>
            
                    <a href="../author/derek/index.html" class="static-avatar">
                        <img class="author-profile-image" src="http://www.gravatar.com/avatar/9f3ee838eeb42849d4880676cedd85d6?s=250&amp;d=mm&amp;r=x" alt="Derek Chen" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/derek/index.html">Derek Chen</a></span>
                <span class="post-card-byline-date"><time datetime="2016-02-19">19 Feb 2016</time> <span class="bull">&bull;</span> 2 min read</span>
            </div>
        </footer>

    </div>

</article>
        </div>
    </div>
</aside>




        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="../index.html">More Than One Turn</a> &copy; 2020</section>
                <nav class="site-footer-nav">
                    <a href="../index.html">Latest Posts</a>
                    
                    <a href="https://twitter.com/derekchen14" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>


    <script
        src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous">
    </script>
    <script src="../assets/built/casper.js%3Fv=245ecc38c2"></script>

    <script>
        // Parse the URL parameter
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // Give the parameter a variable name
        var action = getParameterByName('action');

        $(document).ready(function () {
            if (action == 'subscribe') {
                $('body').addClass("subscribe-success");
            }

            $('.subscribe-success-message .subscribe-close').click(function () {
                $('.subscribe-success-message').addClass('close');
            });

            // Reset form on opening subscrion overlay
            $('.subscribe-button').click(function() {
                $('.subscribe-overlay form').removeClass();
                $('.subscribe-email').val('');
            });
        });
    </script>

    <script>
    $(document).ready(function () {
        // FitVids - start
        var $postContent = $(".post-full-content");
        $postContent.fitVids();
        // FitVids - end

        // Replace nav with title on scroll - start
        Casper.stickyNavTitle({
            navSelector: '.site-nav-main',
            titleSelector: '.post-full-title',
            activeClass: 'nav-post-title-active'
        });
        // Replace nav with title on scroll - end

        // Hover on avatar
        var hoverTimeout;
        $('.author-list-item').hover(function () {
            var $this = $(this);

            clearTimeout(hoverTimeout);

            $('.author-card').removeClass('hovered');
            $(this).children('.author-card').addClass('hovered');

        }, function () {
            var $this = $(this);

            hoverTimeout = setTimeout(function () {
                $this.children('.author-card').removeClass('hovered');
            }, 800);
        });
    });
</script>


    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
</html>
