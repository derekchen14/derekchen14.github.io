<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>How to Fix Memory Error when training on AWS GPU with Keras</title>

    <meta name="description" content="Error allocating 86118 KBs of device memory (out of memory).  Driver report 32735 KBs free and 4294771 KBs total. Fixing this can be quite involved ..." />
    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="More Than One Turn" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="How to Fix Memory Error when training on AWS GPU with Keras" />
    <meta property="og:description" content="Error allocating 86118 KBs of device memory (out of memory).  Driver report 32735 KBs free and 4294771 KBs total. Fixing this can be quite involved ..." />
    <meta property="og:url" content="http://localhost:2368/memory-error-when-training-keras-in-aws-gpus/" />
    <meta property="article:published_time" content="2016-03-07T00:00:00.000Z" />
    <meta property="article:modified_time" content="2016-03-29T16:25:00.000Z" />
    <meta property="article:tag" content="gpu" />
    <meta property="article:tag" content="memory error" />
    <meta property="article:tag" content="deep learning" />
    <meta property="article:tag" content="theano" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="How to Fix Memory Error when training on AWS GPU with Keras" />
    <meta name="twitter:description" content="Error allocating 86118 KBs of device memory (out of memory).  Driver report 32735 KBs free and 4294771 KBs total. Fixing this can be quite involved ..." />
    <meta name="twitter:url" content="http://localhost:2368/memory-error-when-training-keras-in-aws-gpus/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Derek Chen" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="gpu, memory error, deep learning, theano" />
    <meta name="twitter:site" content="@derekchen14" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "More Than One Turn",
        "url": "http://localhost:2368/",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "Derek Chen",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/9f3ee838eeb42849d4880676cedd85d6?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://localhost:2368/author/derek/",
        "sameAs": []
    },
    "headline": "How to Fix Memory Error when training on AWS GPU with Keras",
    "url": "http://localhost:2368/memory-error-when-training-keras-in-aws-gpus/",
    "datePublished": "2016-03-07T00:00:00.000Z",
    "dateModified": "2016-03-29T16:25:00.000Z",
    "keywords": "gpu, memory error, deep learning, theano",
    "description": "For my Stanford Convolutional Neural Networks course\n[http://cs231n.stanford.edu], I partnered with a brilliant friend of mine to\nanalyze images from a collection of 40,000 digitized works of art by classifying\nthem according to artist, genre, and location. After some standard\npre-processing, we employed a modified VGGNet architecture to achieve better\nthan state-of-the-art results [http://arxiv.org/pdf/1505.00855v1.pdf] on artist\nand genre classification. Along the way though, we hit a number o",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.29" />
    <link rel="alternate" type="application/rss+xml" title="More Than One Turn" href="../../rss/index.html" />

    <style amp-custom>
    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: #1292EE;
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: #000;
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #dc0050;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "•";
        margin: 0 .5em;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                More Than One Turn
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Memory Error when Training in AWS GPUs</h1>
                <section class="post-meta">
                    Derek Chen -
                    <time class="post-date" datetime="2016-03-07">07 Mar 2016</time>
                </section>
            </header>
            <section class="post-content">

                <p>For my Stanford <a href="http://cs231n.stanford.edu">Convolutional Neural Networks course</a>, I partnered with a brilliant friend of mine to analyze images from a collection of 40,000 digitized works of art by classifying them according to artist, genre, and location.  After some standard pre-processing, we employed a modified VGGNet architecture to achieve better than <a href="http://arxiv.org/pdf/1505.00855v1.pdf">state-of-the-art results</a> on artist and genre classification. Along the way though, we hit a number of roadblocks, and saw <code>Error allocating 86118400 bytes of device memory (out of memory). Driver report 32735232 bytes free and 4294770688 bytes total.  Segmentation fault (core dumped)</code> more times than we would like to remember.  In getting our network to  run to properly, we encountered a number of problems and their solutions.</p>
<p><strong>Quick Fixes</strong><br />
If you haven't done any kind of optimization yet:</p>
<ul>
<li>Consider running your network on a <a href="http://localhost:2368/memory-error-when-training-keras-in-aws-gpus/feature.engineering/training-on-big-data/">AWS 2.2xlarge GPU</a> or a similar offering from another cloud provider.  Not only will this provide a boost in power, your cloud instance will likely have greater memory to work with as well.</li>
<li>Reduce the size of your network by removing extra layers or limit the number of nodes per layer.  Think about other straightforward variables you can reduce, such as the number of examples to train on.  This will likely lower the final accuracy of the neural net, but if you're just trying to get something to run, limiting the network is a good place to start.</li>
<li>Close all other programs that are running on your computer that might be eating up memory.  <a href="http://lifehacker.com/why-chrome-uses-so-much-freaking-ram-1702537477">Chrome</a> and its independent tab processes are often a hungry source for gobbling up CPU and RAM.  Use <a href="https://support.apple.com/en-us/HT201464">Activity Monitor</a> from your Mac OSX toolbox to find out what other culprits might be at play.</li>
<li>Simplify the architecture of your overall system by commenting it out.  For example, if your final prediction uses ensembling from multiple models, temporarily use just a single model at a time.  The same idea applies for data augmentation, complex feature engineering, and using specialized hyperparameters.</li>
</ul>
<p><strong>Diving Deeper</strong><br />
This next level of ideas requires the user to dig into their code a bit to understand what is happening.  Simple editing of a copy/pasted example file will no longer suffice:</p>
<ul>
<li>Compiled models potentially hold onto millions of weights and variables in addition their actual structure, and should not be stored unnecessarily.  As an example, assume you are training multiple networks at once during a grid search for hyperparameters.     During each training loop, you store the best model so that you can  use it during the testing phase.  A better use of memory though might be to store just the best params used in creating the model, rather than the full model itself.</li>
<li>Reduce your the batch size of each epoch.  While this may seem like a quick fix, it requires understanding the trade-offs between having different sized batches.  Additionally, unless the neural network was written in a clean style, changing this variable might involve touching multiple places in your code.</li>
<li>Load your input vectors as 'float32' rather than 'float64', which is the default of <code>numpy.load</code> using the <code>astype()</code> method.  In most cases, your network will not benefit from having the extra precision of the extra 32 bits, so changing the input type can be a great way to cut down your feature memory usage in half.</li>
<li>If your dataset is too large, you can try splitting your dataset into smaller chunks so that each individual piece can fit into memory.  This process can be performed by simply chunking up your data through numpy if you are planning to save the features as .npy files.  Alternatively, h5py has methods that allow the user to pull only certain slices of the data into memory at once.  Keras offers a nice wrapper around this functionality in their <a href="https://github.com/fchollet/keras/blob/master/keras/utils/io_utils.py#L7">I/O tools</a>.</li>
</ul>
<p><strong>Finding Root Causes</strong><br />
Finally, Linux command line tools can help pinpoint the exact moment where your network falls apart:</p>
<ul>
<li>To find out how much CPU memory is available, you can use <code>top</code> or <code>watch free</code> to tail the logs. In order to get more human-readable output for top, press Shift+E.  Similarly, in order to get more human-readable output for free, use the <code>-k</code> or <code>-m</code> flag to get kilobytes and megabytes, respectively.  It can be quite beneficial to <a href="http://www.linuxnix.com/find-ram-size-in-linuxunix/">study the guides</a> briefly to gain a better understanding of the output as opposed to blindly jumping in.</li>
<li>Get GPU memory information by using <code>nvidia-smi</code> or <code>intel_gpu_top</code> for Nvidia and Intel chips, respectively.  Many times you should know the maximum capacity of your graphics card, so be sure that the numbers you see line up with your understanding.  For the typical AWS GPU, this will be 4GB of video memory.  Once again, investing some time perusing the <a href="https://developer.nvidia.com/nvidia-system-management-interface">documentation</a> or just some brief searching can prove to be invaluable.</li>
<li>Use <code>timer.sleep(x)</code> in order to pause processing so you can see what memory allocation is directly before and after you perform an action, such as creating a new variable.  Combined with the tools above, you should now be able to see exactly when memory usage starts to explode, and hopefully what source caused it to happen.</li>
<li>Once the issue has been identified, consider if any of the techniques mentioned earlier might ameliorate the situation.  Another idea is setting any data or weights to None after you are done using them.  For example, in the case where new chunks of data are loaded sequentially to train the network, setting <code>X_train = None</code> and <code>y_train = None</code> at the end of each loop could make a difference.</li>
<li>Finally, although Python should take care of garbage collection pretty well, using <code>sys.stdout.flush()</code> to clear out any unused variables could make the difference.</li>
</ul>
<p>Like any good programmer, I simply kept forging ahead until I was able to figure out something that worked.  Thus, for my purposes,  these methods were enough to get my network to run to completion, and I hope they will help you as well.  Although, if problems still remain despite having pushed this far, and you are adamant of running your network at full capacity, then it might be time to invest in a <a href="http://timdettmers.com/2014/08/14/which-gpu-for-deep-learning/">more powerful chip</a> and develop your own custom set-up.</p>
<p>With practically unlimited access to resources, the folks at Google, Facebook, and Baidu certainly aren't facing the same type of issues, and instead are employing techniques well beyond the scope of this article.  However, using just hardware generally available to the public, even amateur researchers might be able to push these ideas further than I have.  If you are one of these people, please leave your tips and tricks in the comments below.</p>


            </section>

        </article>
    </main>
    <footer class="page-footer">
        <h3>More Than One Turn</h3>
            <p>Thoughts about Conversational AI and interactive dialogue systems.</p>
        <p><a href="../../index.html">Read more posts →</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a></span>
    </footer>
    
</body>
</html>